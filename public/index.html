<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personalized Video Demo</title>
  
  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-functions-compat.js"></script>

  <!-- Include your Firebase config file -->
  <script src="firebaseConfig.js"></script>
</head>
<body>
  <h1>Create Personalized Video</h1>
  <form id="personalizedForm">
    <label for="first_name">Child's Name:</label>
    <input type="text" id="first_name" name="first_name" required><br>
    
    <label for="email">Email:</label>
    <input type="text" id="email" name="email" required><br>
    
    <label for="age">Age:</label>
    <input type="number" id="age" name="age" required><br>
    
    <label for="teacher">Select Teacher:</label>
    <select id="teacher" name="teacher" required>
      <option value="Teacher A">Toby</option>
      <option value="Teacher B">Teacher B</option>
    </select><br>

    <label for="datetime">Select Time & Date:</label>
    <input type="datetime-local" id="datetime" name="datetime" required><br>

    <label for="language">Select Language:</label>
    <select id="language" name="language" required>
      <option value="english">English</option>
      <option value="russian">Russian</option>
      <option value="turkish">Turkish</option>
    </select><br>

    <button type="submit">Submit</button>
  </form>

  <div id="videoSection" style="display: none;">
    <h2>Your Personalized Video</h2>
    <video id="personalizedVideo" controls></video>
  </div>

  <script>

    document.getElementById("personalizedForm").addEventListener("submit", async function(event) {
      event.preventDefault();

      // Collect form data
      const first_name = document.getElementById("first_name").value;
      const email = document.getElementById("email").value;
      const datetime = document.getElementById("datetime").value;
      const language = document.getElementById("language").value;

      // Log form data for debugging
      console.log("Form data:", {
        first_name: first_name,
        email: email,
        datetime: datetime,
        language: language
      });

      // Check if any data is missing
      if (!first_name || !email || !datetime || !language) {
        console.error("Form data is missing:", { first_name, email, datetime, language });
        alert("Please fill in all required fields.");
        return;
      }

      // Call Firebase function to make API request
      const makeVideo = functions.httpsCallable('createPersonalizedVideo');
      
      try {
        const response = await makeVideo({ first_name, email, datetime, language });
        console.log("Response received:", response);

        const audienceId = response.data.audienceId;
        console.log("Audience ID:", audienceId);

        // Polling for video status
        let videoReady = false;

        while (!videoReady) {
          const statusResponse = await checkVideoStatus(audienceId);
          console.log("Status Response:", statusResponse);

          if (statusResponse.status === "ready") {
            console.log("Video is now ready!");
            videoReady = true;
            document.getElementById("videoSection").style.display = "block";
            document.getElementById("personalizedVideo").src = statusResponse.video_url;
          } else {
            console.log("Still waiting for video, checking again in 5 seconds...");
            await new Promise(resolve => setTimeout(resolve, 5000));  // Wait for 5 seconds
          }
        }
      } catch (error) {
        console.error("Error while creating personalized video:", error);
        alert("An error occurred while creating the video. Please try again later.");
      }
    });

    // Helper function to call checkVideoStatus
    async function checkVideoStatus(audienceId) {
      const statusFunction = functions.httpsCallable('checkVideoStatus');
      const response = await statusFunction({ audienceId });
      return response.data;
    }
  </script>
</body>
</html>
